PREFIX tsc: <http://paper.9bon.org/ontologies/smartcity/0.2#>
PREFIX sta: <http://paper.9bon.org/ontologies/sensorthings/1.1#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

SELECT ?areaName ?latestResultTime ?latestTemperature ?avgPM
WHERE {
    {
        SELECT ?areaName (AVG(?temperature) AS ?avgPM)
        WHERE {
            ?area tsc:hasName ?areaName .
            ?area tsc:hasThing/sta:hasMultiDatastream/sta:hasIndexpoint ?indexpoint .
            ?indexpoint sta:pointToMultiObservedProperty ?obsProp .
            ?obsProp sta:hasname "Air Temperature" .
            ?indexpoint sta:pointToresult ?resultResource .
            ?resultResource sta:hasvalue ?temperature .
        }
        GROUP BY ?areaName
        ORDER BY DESC(?avgPM)
        LIMIT 1
    }

    ?area tsc:hasName ?areaName .
    ?area tsc:hasThing/sta:hasMultiDatastream/sta:hasIndexpoint ?indexpoint .
    ?indexpoint sta:pointToMultiObservedProperty ?latestObsProp .
    ?latestObsProp sta:hasname "Air Temperature" .
    ?indexpoint sta:pointToresult ?latestResultResource .
    ?latestResultResource sta:hasvalue ?latestTemperature ;
                        sta:isresultByObservation/sta:hasresultTime ?latestResultTime .
}
ORDER BY DESC(?latestResultTime)
LIMIT 1
